<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie Rater</title>
    <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.17.0/dist/jquery.validate.js" type="application/javascript"></script>
    <style>
        #errorArea{color:red}
    </style>
</head>


<body>

<h1>Code District Aws Class Movie Rater</h1>

<table>
    <tr>
        <td>
            Search for a Movie
        </td>
        <td>
            <input id="movieSearch"/>
            <button id="search" onclick="search('movieSearch')">Search</button>
        </td>
    </tr>
    <tr>
        <td>
            Movie
        </td>
        <td>
            <select id="movie"></select>
        </td>
    </tr>
    <tr>
        <td>
            Rating
        </td>
        <td>
            <select id="rating"></select>
        </td>
    </tr>
    <tr>
        <td>
            Rater Email
        </td>
        <td>
            <input id="raterEmail"/><div id="errorArea"></div>
        </td>
    </tr>
    <tr>
        <td>
            Submit
        </td>
        <td>
            <input type="submit" id="submit" onclick="submitRating()"/>
        </td>
    </tr>
    <tr>
        <td>
            Your Rating ID
        </td>
        <td>
            <div id="ratingId"></div>
        </td>
    </tr>
</table>
<table id="myRatings" >
    <tr>
        <th>Movie</th>
        <th>Rating</th>
        <th>Rater</th>

    </tr>

</table>
<script>

    var API_URL = 'https://opna2oxd2e.execute-api.us-east-1.amazonaws.com/Test';
    //var API_URL = 'YOUR_TEST_DEPLOY_URI';

    function populateRatingTable(data){

        //alert(JSON.stringify(data));
        var tbl = document.getElementById("myRatings");
        data.forEach(function(row){
            var str = '<td>' + row.movieTitle.S + '</td>';
            str += '<td>' + row.rating.N + '</td>'
            str += '<td>' + row.userEmail.S + '</td>'
            $("#myRatings").last().append('<tr>' + str + '</tr>');
        });
    }


    function search(dataId) {
        cleanupUi();
        var searchData = document.getElementById(dataId).value;
        var uri = encodeURI(API_URL + '/movies?search=' + searchData);
        //alert('I am searching: ' + uri);
        $.get(uri, function (data) {
            populateMovies(data);
        });
    }

    function removeOptions(selectbox)
    {
        var i;
        for(i = selectbox.options.length - 1 ; i >= 0 ; i--)
        {
            selectbox.remove(i);
        }
    }

    function cleanupUi(){
        removeOptions($('#movie')[0]);
        $('#raterEmail')[0].value = '';
        $('#rating option:selected').prop('selected', false);
        $('#rating option:first').prop('selected", "selected');
        $('#ratingId')[0].innerText = '';

    }
    function populateMovies(data) {
        //make a list of movies
        var movies = data;
        //find the movies dropdown
        var movieElement = document.getElementById("movie");
        removeOptions(movieElement);

        var op = document.createElement('option');
        op.innerHTML = "Select  a Movie";
        op.value = 0;
        movieElement.appendChild(op);



        for (var i = 0; i < movies.length; i++) {
            var option = document.createElement('option');
            option.innerHTML = movies[i].title;
            option.value = movies[i].id;
            movieElement.appendChild(option)
        }

    }

    function populateRatings() {
        //create rating array
        var ratings = [];
        ratings.push({"rating": -1, "text": "Select a rating"});
        ratings.push({"rating": 0, "text": "Awful"});
        ratings.push({"rating": 1, "text": "Not too Bad"});
        ratings.push({"rating": 2, "text": "OK"});
        ratings.push({"rating": 3, "text": "Good"});
        ratings.push({"rating": 4, "text": "Great!"});
        ratings.push({"rating": 4, "text": "Super  Great!"});

        //find the rating dropdown
        var ratingElement = document.getElementById("rating");

        for (var i = 0; i < ratings.length; i++) {
            var option = document.createElement('option');
            option.innerHTML = ratings[i].text;
            option.value = ratings[i].rating;
            ratingElement.appendChild(option)
        }
    }

    function isEmailValid(mail)
    {
        if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail))
        {
            return (true)
        }
        return (false)
    }

    function validateEmail() {
        var email =  $("#raterEmail")[0].value;
        if(!isEmailValid(email)){
            $("#errorArea")[0].innerHTML = 'Bad email address';
            return false;
        }else{
            $("#errorArea")[0].innerHTML = '';
        }
        return true;
    }

    function submitRating() {
        if(!validateEmail()) return;

        var rating = {};
        var e = document.getElementById("rating");
        rating.text = e.options[e.selectedIndex].text;
        rating.value = e.options[e.selectedIndex].value;


        var submission = {}
        var e = document.getElementById("movie");
        submission.movieTitle = e.options[e.selectedIndex].text;
        submission.movieId = e.options[e.selectedIndex].value;

        var email = document.getElementById("raterEmail").value;
        submission.userEmail = email;
        submission.rating = rating.value;

        var uri = encodeURI(API_URL + '/ratings');
        $.ajax({
            url:uri,
            type:"POST",
            data: JSON.stringify(submission),
            contentType:"application/json; charset=utf-8",
            dataType:"json",
            success: function(data){
                //alert( "ata Loaded: " + JSON.stringify(data) );
                document.getElementById("ratingId").innerHTML = data.ratingId;
                var uri = encodeURI(API_URL + '/ratings?userEmail=' + submission.userEmail);
                //alert('I am searching: ' + uri);
                $.get(uri, function (data) {
                    populateRatingTable(data);
                });
            }
        });
    }

    //populateMovies();
    populateRatings();

</script>

</body>
</html>
